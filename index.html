class TelegramDice {
    constructor() {
        this.tg = window.Telegram.WebApp;
        this.initTelegramApp();
        
        this.dice = document.getElementById('dice');
        this.rollButton = document.getElementById('rollButton');
        this.resultElement = document.getElementById('result');
        this.totalRollsElement = document.getElementById('totalRolls');
        this.lastRollsElement = document.getElementById('lastRolls');
        
        this.totalRolls = 0;
        this.lastRolls = [];
        this.isRolling = false;
        
        this.initializeEventListeners();
        this.loadFromStorage();
        this.updateDisplay();
    }
    
    initTelegramApp() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        this.tg.expand();
        this.tg.enableClosingConfirmation();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
        document.documentElement.style.setProperty('--tg-theme-bg-color', this.tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', this.tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', this.tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', this.tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', this.tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', this.tg.themeParams.secondary_bg_color || '#f0f0f0');
    }
    
    initializeEventListeners() {
        this.rollButton.addEventListener('click', () => this.rollDice());
        
        // –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –ø—Ä–æ–±–µ–ª–∞
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' && !this.isRolling) {
                event.preventDefault();
                this.rollDice();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const diff = touchStartY - touchEndY;
            
            // –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö –¥–ª—è –±—Ä–æ—Å–∫–∞ –∫—É–±–∏–∫–∞
            if (diff > 50 && !this.isRolling) {
                this.rollDice();
            }
        });
    }
    
    rollDice() {
        if (this.isRolling) return;
        
        this.isRolling = true;
        this.rollButton.disabled = true;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
        this.dice.classList.add('rolling');
        this.resultElement.textContent = '?';
        this.resultElement.classList.remove('result-pop');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
        const result = Math.floor(Math.random() * 6) + 1;
        
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            this.showResult(result);
            this.dice.classList.remove('rolling');
            this.isRolling = false;
            this.rollButton.disabled = false;
        }, 800);
    }
    
    showResult(result) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        this.totalRolls++;
        this.lastRolls.unshift(result);
        if (this.lastRolls.length > 5) {
            this.lastRolls.pop();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.resultElement.textContent = result;
        this.resultElement.classList.add('result-pop');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫—É–±–∏–∫–µ
        this.dice.setAttribute('data-value', result);
        
        // –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        this.saveToStorage();
        this.updateDisplay();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        this.sendToTelegram(result);
    }
    
    updateDisplay() {
        this.totalRollsElement.textContent = this.totalRolls;
        this.lastRollsElement.textContent = this.lastRolls.slice(0, 3).join(', ');
    }
    
    saveToStorage() {
        const data = {
            totalRolls: this.totalRolls,
            lastRolls: this.lastRolls
        };
        localStorage.setItem('telegramDiceData', JSON.stringify(data));
    }
    
    loadFromStorage() {
        const saved = localStorage.getItem('telegramDiceData');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.totalRolls = data.totalRolls || 0;
                this.lastRolls = data.lastRolls || [];
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }
    }
    
    sendToTelegram(result) {
        // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞
        // this.tg.sendData(JSON.stringify({ type: 'dice_roll', result: result }));
        
        // –ò–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        this.tg.showPopup({
            title: 'üé≤ –†–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞',
            message: `–í—ã–ø–∞–ª–æ: ${result}`,
            buttons: [{ type: 'ok' }]
        });
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    resetStats() {
        this.totalRolls = 0;
        this.lastRolls = [];
        this.saveToStorage();
        this.updateDisplay();
        this.resultElement.textContent = '-';
        this.dice.removeAttribute('data-value');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–æ–≥–¥–∞ –≤—Å—ë –∑–∞–≥—Ä—É–∂–µ–Ω–æ
document.addEventListener('DOMContentLoaded', () => {
    // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        new TelegramDice();
    } else {
        // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
        console.log('–ó–∞–ø—É—Å–∫ –≤–Ω–µ Telegram');
        new TelegramDice();
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram
window.resetDiceStats = function() {
    if (window.diceApp) {
        window.diceApp.resetStats();
    }
};